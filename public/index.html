<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JNTUH Results</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="input">
        <h2>JNTUH Academic Results</h2>
        <form id="resultsForm">
          <div class="hall">
            <p>Enter Halticket No:</p>
            <input type="text" id="rollNoInput" />
          </div>
          <button onclick="fetchResults()">Results</button>
        </form>
      </div>
      <div id="resultContainer"></div>
      <div class="made">
        <p>
          Made with ‚ù§ by <a href="https://github.com/prrranay">Pranay Kumar</a>
        </p>
      </div>
    </div>

    <script>
      document
        .getElementById("resultsForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          fetchResults();
        });
      function fetchResults() {
        var rollNo = document.getElementById("rollNoInput").value;
        var apiUrl = `/fetch_results?rollNo=${rollNo}`;

        fetch(apiUrl)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            displayResults(data);
          })
          .catch((error) => {
            console.error("Error fetching results:", error);
            displayError("Failed to fetch results. Please try again later.");
          });
      }

      function displayResults(data) {
        var resultContainer = document.getElementById("resultContainer");
        resultContainer.innerHTML = ""; // Clear previous results

        if (!data || !data.Details || !data.Results) {
          displayError("No results found.");
          return;
        }

        // Display loading indicator
        resultContainer.innerHTML = "<p>Loading...</p>";

        // Fetching results
        setTimeout(function () {
          // Display student details
          var detailsHTML = `<h2>Student Details</h2>
                          <p>Name: ${data.Details.NAME}</p>
                          <p>Roll Number: ${data.Details.Roll_No}</p>
                          <p>College Code: ${data.Details.COLLEGE_CODE}</p>
                          <p>Father's Name: ${data.Details.FATHER_NAME}</p>`;

          // Display fetched results
          var resultHTML = "<h2>Results</h2>";
          var totalCGPA = 0;
          var totalSemesters = 0;
          var totalBacklogs = 0;

          for (const semester in data.Results) {
            if (semester === "Total") {
              continue; // Skip iterating over "Total" key
            }

            const semesterData = data.Results[semester];
            if (!semesterData || Object.keys(semesterData).length === 0) {
              continue; // Skip if no valid subjects found for the semester
            }

            totalSemesters++;

            resultHTML += `<h3>Semester ${semester}</h3>`;
            resultHTML +=
              "<table><tr><th>Subject Code</th><th>Subject Name</th><th>Internal</th><th>External</th><th>Grade</th><th>Credits</th></tr>";

            for (const subjectCode in semesterData) {
              const subject = semesterData[subjectCode];
              if (
                subject.subject_code &&
                subject.subject_name &&
                subject.subject_internal &&
                subject.subject_external &&
                subject.subject_grade &&
                subject.subject_credits
              ) {
                let grade = subject.subject_grade;
                if (grade === "F") {
                  totalBacklogs++;
                }
                resultHTML += `<tr><td>${subject.subject_code}</td><td>${subject.subject_name}</td><td>${subject.subject_internal}</td><td>${subject.subject_external}</td><td>${grade}</td><td>${subject.subject_credits}</td></tr>`;
              }
            }

            const semesterCGPA = parseFloat(semesterData.CGPA);
            if (!isNaN(semesterCGPA)) {
              totalCGPA += semesterCGPA;
              resultHTML += `<tr><td colspan="6">CGPA: ${semesterCGPA}</td></tr>`;
            } else {
              resultHTML += `<tr><td colspan="6">CGPA: -</td></tr>`;
            }

            resultHTML += "</table>";
          }

          // Calculate SGPA (average CGPA)
          const sgpa = totalSemesters > 0 ? totalCGPA / totalSemesters : 0;

          // Display SGPA and backlogs
          resultHTML += `<h3>SGPA</h3><p>${sgpa.toFixed(2)}</p>`;
          resultHTML += `<h3>Backlogs</h3><p>${totalBacklogs}</p>`;

          resultContainer.innerHTML = detailsHTML + resultHTML;
        }, 2000); // Simulating loading delay of 2 seconds
      }

      function displayError(message) {
        var resultContainer = document.getElementById("resultContainer");
        resultContainer.innerHTML = `<div style="color: red;">${message}</div>`;
      }
    </script>
  </body>
</html>
